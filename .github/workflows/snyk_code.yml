name: "Snyk Code Test"

on:
  workflow_dispatch:
  
jobs:
  Pipeline-Job:
    # Configure Environment
    name: 'Snyk Test'
    runs-on: ubuntu-latest
    # env: 
      # SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}SNYK
      # SNYK_TOKEN: $(aws secretsmanager get-secret-value --secret-id SNYK_API_TOKEN | jq .SecretString)
      
    
       
    steps:
    - name: check-user
      run: whoami
    - name: Set up AWS CLI
      run: |
        export AWS_DEFAULT_REGION=us-west-2
        export AWS_SDK_LOAD_CONFIG=1
    - name: Generate IMDSv2 Token
      id: generate_token
      run: |
        TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
        echo "TOKEN=$TOKEN" >> $GITHUB_ENV

    - name: Use IMDSv2 Token to Get IAM Role
      run: |
        curl -H "X-aws-ec2-metadata-token: $TOKEN" "http://169.254.169.254/latest/meta-data/iam/security-credentials/"
    - name: Test AWS CLI
      run: aws sts get-caller-identity --debug
    # - name: check-snyk-token
    #  run: aws secretsmanager get-secret-value --secret-id SNYK_API_TOKEN --query 'SecretString' --output text

    - name: Fetch secret from AWS Secrets Manager
      id: fetch-secret
      run: |
        secret_value=$(aws secretsmanager get-secret-value --secret-id SNYK_API_TOKEN --query SecretString --output text)
        echo "SECRET_VALUE=${secret_value}" >> $GITHUB_ENV
        
    # Checkout Code
    - name: Checkout Code
      uses: actions/checkout@v1

    # Install and Authenticate to Snyk
    - name: Install Snyk & Authenticate
      run: |
         sudo npm install -g snyk
         snyk auth ${SECRET_VALUE}
    # Run Snyk Code
    - name: Run Snyk Code
      run: |
         snyk code test  
      continue-on-error: true
